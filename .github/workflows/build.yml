name: Build ImmortalWrt x86_64 Complete

on:
  workflow_dispatch:
    inputs:
      firmware_version:
        description: 'ImmortalWrt 版本'
        required: true
        default: 'v24.10.2' # 建议使用最新的稳定版以获得最佳的软件源兼容性
        type: choice
          - 'v23.05.4'
          - 'v24.10.2'
      include_docker:
        description: '包含 Docker 支持'
        required: true
        default: true
        type: boolean
      include_passwall2:
        description: '包含 PassWall2 等代理工具'
        required: true
        default: true
        type: boolean
      rootfs_size:
        description: '根分区大小 (MB)'
        required: true
        default: '1024'
      kernel_size:
        description: '内核分区大小 (MB)'
        required: true
        default: '32'

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Initialize Build Environment
      run: |
        echo "=== 初始化构建环境 ==="
        df -h /

    - name: Free Up Disk Space
      run: |
        echo "=== 清理磁盘空间 ==="
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /usr/local/go /opt/hostedtoolcache
        sudo docker image prune -a -f
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
        echo "=== 清理后磁盘状态 ==="
        df -h /

    - name: Install Dependencies
      run: |
        echo "=== 安装编译依赖 ==="
        sudo apt-get update -qq
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libncursesw5-dev libssl-dev python3 \
          python3-dev python3-setuptools rsync swig unzip zlib1g-dev file wget \
          curl time xsltproc libelf-dev ccache

    - name: Set Build Variables
      run: |
        case "${{ github.event.inputs.firmware_version }}" in
          "v24.10.2")
            echo "REPO_BRANCH=openwrt-24.10" >> $GITHUB_ENV
            echo "REPO_VERSION=v24.10.2" >> $GITHUB_ENV
            echo "OPENWRT_VERSION=24.10" >> $GITHUB_ENV
            ;;
          "v23.05.4")
            echo "REPO_BRANCH=openwrt-23.05" >> $GITHUB_ENV
            echo "REPO_VERSION=v23.05.4" >> $GITHUB_ENV
            echo "OPENWRT_VERSION=23.05" >> $GITHUB_ENV
            ;;
        esac
        echo "REPO_URL=https://github.com/immortalwrt/immortalwrt" >> $GITHUB_ENV
        echo "BUILD_DATE=$(date +'%Y%m%d')" >> $GITHUB_ENV
        echo "FIRMWARE_SIZE=${{ github.event.inputs.rootfs_size }}" >> $GITHUB_ENV
        echo "KERNEL_SIZE=${{ github.event.inputs.kernel_size }}" >> $GITHUB_ENV

    - name: Clone Source Code
      run: |
        echo "=== 克隆 ImmortalWrt 源码 ==="
        git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt
        cd openwrt
        git fetch --depth 1 origin tag $REPO_VERSION
        git checkout $REPO_VERSION

    - name: Update and Install Feeds
      run: |
        echo "=== 添加并安装第三方软件源 ==="
        cd openwrt
        
        # ✅ FIX: 添加包含 Passwall, OpenClash 等插件的第三方软件源
        echo 'src-git openclash https://github.com/vernesong/OpenClash.git' >> feeds.conf.default
        echo 'src-git passwall https://github.com/xiaorouji/openwrt-passwall.git' >> feeds.conf.default
        echo 'src-git homeproxy https://github.com/immortalwrt-collections/homeproxy.git' >> feeds.conf.default
        
        # 更新软件源
        ./scripts/feeds update -a
        
        # 安装软件源
        ./scripts/feeds install -a

    - name: Generate Configuration
      run: |
        echo "=== 生成编译配置 ==="
        cd openwrt
        
        # 创建配置文件
        cat > .config << EOF
        # Target Platform
        CONFIG_TARGET_x86=y
        CONFIG_TARGET_x86_64=y
        CONFIG_TARGET_x86_64_DEVICE_generic=y
        
        # Target Images
        CONFIG_TARGET_KERNEL_PARTSIZE=${{ env.KERNEL_SIZE }}
        CONFIG_TARGET_ROOTFS_PARTSIZE=${{ env.FIRMWARE_SIZE }}
        CONFIG_TARGET_IMAGES_PAD=y
        CONFIG_GRUB_TIMEOUT="3"
        CONFIG_GRUB_TITLE="ImmortalWrt"
        CONFIG_GRUB_IMAGES=y
        CONFIG_GRUB_EFI_IMAGES=y
        CONFIG_TARGET_ROOTFS_EXT4FS=y
        CONFIG_TARGET_ROOTFS_SQUASHFS=y
        
        # Base System
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-ssl-openssl=y
        
        # Drivers
        CONFIG_PACKAGE_kmod-igc=y
        CONFIG_PACKAGE_kmod-r8125=y
        CONFIG_PACKAGE_kmod-igb=y
        CONFIG_PACKAGE_kmod-e1000e=y
        CONFIG_PACKAGE_kmod-r8169=y
        
        # USB and Storage
        CONFIG_PACKAGE_kmod-usb-core=y
        CONFIG_PACKAGE_kmod-usb2=y
        CONFIG_PACKAGE_kmod-usb3=y
        CONFIG_PACKAGE_kmod-fs-ext4=y
        
        # Language Support
        CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
        CONFIG_PACKAGE_luci-i18n-firewall-zh-cn=y
        CONFIG_PACKAGE_luci-i18n-opkg-zh-cn=y
        EOF
        
        if [ "${{ github.event.inputs.include_docker }}" == "true" ]; then
          cat >> .config << 'DOCKER_EOF'
        
        # Docker Support
        CONFIG_PACKAGE_luci-app-dockerman=y
        CONFIG_PACKAGE_docker=y
        CONFIG_PACKAGE_dockerd=y
        CONFIG_PACKAGE_luci-i18n-dockerman-zh-cn=y
        DOCKER_EOF
        fi
        
        if [ "${{ github.event.inputs.include_passwall2 }}" == "true" ]; then
          cat >> .config << 'PROXY_EOF'
        
        # Proxy Tools
        CONFIG_PACKAGE_luci-app-openclash=y
        CONFIG_PACKAGE_luci-app-homeproxy=y
        CONFIG_PACKAGE_luci-app-passwall=y
        CONFIG_PACKAGE_luci-app-passwall2=y
        CONFIG_PACKAGE_luci-i18n-passwall-zh-cn=y
        CONFIG_PACKAGE_luci-i18n-passwall2-zh-cn=y
        CONFIG_PACKAGE_luci-i18n-openclash-zh-cn=y
        CONFIG_PACKAGE_luci-i18n-homeproxy-zh-cn=y
        PROXY_EOF
        fi
        
        make defconfig

    - name: Download Dependencies
      run: |
        echo "=== 下载编译依赖 ==="
        cd openwrt
        make download -j$(nproc)

    - name: Compile Firmware
      run: |
        echo "=== 开始编译固件 (过程会很长) ==="
        cd openwrt
        make -j1 V=s

    - name: Check Build Results
      run: |
        echo "=== 检查编译结果 ==="
        if [ ! -d "openwrt/bin/targets/x86/64" ] || [ -z "$(ls -A openwrt/bin/targets/x86/64)" ]; then
          echo "错误: 编译失败，未找到固件文件"
          exit 1
        else
          echo "编译成功，固件文件已生成。"
          ls -lh openwrt/bin/targets/x86/64/
        fi

    - name: Organize Firmware Files
      id: organize
      run: |
        FIRMWARE_PATH=$(find openwrt/bin/targets/x86/64 -type d)
        echo "FIRMWARE_PATH=${FIRMWARE_PATH}" >> $GITHUB_ENV
        echo "BUILD_SUCCESS=true" >> $GITHUB_ENV

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ImmortalWrt-${{ env.OPENWRT_VERSION }}-x86_64-${{ env.BUILD_DATE }}
        path: ${{ env.FIRMWARE_PATH }}
        retention-days: 7

    - name: Generate Release Info
      run: |
        echo "RELEASE_TAG=${{ env.OPENWRT_VERSION }}-${{ env.BUILD_DATE }}-$(date +'%H%M')" >> $GITHUB_ENV
        cat > release_notes.md << EOF
        ## ImmortalWrt ${{ env.OPENWRT_VERSION }} x86_64
        **构建时间**: ${{ env.BUILD_DATE }}
        EOF

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: ImmortalWrt ${{ env.OPENWRT_VERSION }} x86_64 - ${{ env.BUILD_DATE }}
        body_path: release_notes.md
        files: ${{ env.FIRMWARE_PATH }}/*
        token: ${{ secrets.GITHUB_TOKEN }}
