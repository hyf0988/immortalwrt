name: Build ImmortalWrt with Image Builder

on:
  workflow_dispatch:
    inputs:
      rootfs_size:
        description: 'è¯·è¾“å…¥å›ºä»¶æ ¹åˆ†åŒºçš„æœ€ç»ˆå¤§å° (MB)'
        required: true
        default: '2048'
      router_ip:
        description: 'è¯·è®¾ç½®è·¯ç”±å™¨çš„é»˜è®¤ç®¡ç†IPåœ°å€'
        required: true
        default: '192.168.8.1'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Build Environment
        id: prepare
        run: |
          # åˆ›å»ºç”¨äºŽå­˜æ”¾è‡ªå®šä¹‰æ–‡ä»¶å’Œæœ€ç»ˆå›ºä»¶çš„ç›®å½•
          mkdir -p files/etc/config bin
          
          # å°†è‡ªå®šä¹‰IPåœ°å€å†™å…¥ç½‘ç»œé…ç½®æ–‡ä»¶
          echo "LAN_IP=${{ github.event.inputs.router_ip }}" > files/etc/config/custom_lan_ip
          
          # å®šä¹‰è½¯ä»¶åŒ…åˆ—è¡¨ (å·²ç§»é™¤ passwall2)
          PACKAGES=" \
            luci \
            luci-ssl \
            ppp \
            luci-proto-ppp \
            luci-app-openclash \
            luci-app-homeproxy \
            luci-app-passwall \
            luci-app-dockerman \
            luci-lib-docker \
            docker \
            dockerd \
            kmod-igb \
            kmod-e1000e \
            kmod-r8169 \
            kmod-r8125 \
            kmod-igc \
            kmod-usb-core \
            kmod-usb2 \
            kmod-usb3 \
            kmod-fs-ext4 \
            kmod-fs-vfat \
            luci-i18n-base-zh-cn \
            luci-i18n-firewall-zh-cn \
            luci-i18n-dockerman-zh-cn \
            luci-i18n-passwall-zh-cn \
            luci-i18n-openclash-zh-cn \
            luci-i18n-homeproxy-zh-cn \
          "
          # å°†è½¯ä»¶åŒ…åˆ—è¡¨å’Œæ ¹åˆ†åŒºå¤§å°ä¿å­˜ä¸ºè¾“å‡ºï¼Œä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "packages=$(echo $PACKAGES | tr -s ' ')" >> $GITHUB_OUTPUT
          echo "rootfs_size=${{ github.event.inputs.rootfs_size }}" >> $GITHUB_OUTPUT

      - name: Build Firmware with Image Builder
        run: |
          # è¿è¡Œå®˜æ–¹çš„Image Builder Dockerå®¹å™¨
          docker run --rm -i \
            --user root \
            -v ./bin:/home/build/immortalwrt/bin \
            -v ./files:/home/build/immortalwrt/files \
            immortalwrt/imagebuilder:x86-64-openwrt-24.10.2 \
            /bin/bash -c '
              # æ·»åŠ åŒ…å«ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…çš„è½¯ä»¶æº
              echo "src/gz kenzok8_packages https://raw.githubusercontent.com/kenzok8/openwrt-packages/master" >> repositories.conf
              echo "src/gz kenzok8_small https://raw.githubusercontent.com/kenzok8/small/master" >> repositories.conf
              
              # æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
              make info
              
              # å¼€å§‹æž„å»ºé•œåƒï¼Œæ·»åŠ  V=s å‚æ•°ä»¥è¾“å‡ºè¯¦ç»†æ—¥å¿—
              make image V=s PROFILE="generic" PACKAGES="${{ steps.prepare.outputs.packages }}" FILES="files" ROOTFS_SIZE="${{ steps.prepare.outputs.rootfs_size }}"
            '

      - name: Organize Files and Create Info
        id: organize
        run: |
          # æŸ¥æ‰¾ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶è·¯å¾„
          FIRMWARE_PATH=$(find ./bin/targets/x86/64 -type f -name "*squashfs-combined-efi.img.gz" | head -n 1)
          if [[ -z "$FIRMWARE_PATH" ]]; then
            echo "::error::å›ºä»¶æ–‡ä»¶æœªæ‰¾åˆ°, æž„å»ºå¤±è´¥!"
            exit 1
          fi
          
          # å°†å›ºä»¶è·¯å¾„è®¾ç½®ä¸ºçŽ¯å¢ƒå˜é‡
          echo "FIRMWARE_PATH=$FIRMWARE_PATH" >> $GITHUB_ENV
          
          # åˆ›å»ºå‘å¸ƒä¿¡æ¯
          cat > ./router-info.md <<EOF
          ## ðŸš€ ImmortalWrt 24.10.2 (Image Builder ç‰ˆ)

          - ðŸ  **åŽå°åœ°å€**: ${{ github.event.inputs.router_ip }}
          - ðŸ‘¤ **ç”¨æˆ·å**: root
          - ðŸ”‘ **å¯†ç **: æ— 
          - ðŸ’¾ **å›ºä»¶å¤§å°**: ${{ github.event.inputs.rootfs_size }} MB
          EOF

      - name: Upload Firmware to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ImmortalWrt-ImageBuilder-$(date +%Y-%m-%d)
          body_path: ./router-info.md
          files: |
            ${{ env.FIRMWARE_PATH }}
          token: ${{ secrets.GITHUB_TOKEN }}
          replace_latest: true
