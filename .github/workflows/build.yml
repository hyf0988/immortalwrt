name: Build ImmortalWrt (Space Optimized)

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10
  REPO_VERSION: v24.10.2
  TZ: Asia/Shanghai
  
jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Initialization Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # æ˜¾ç¤ºåˆå§‹ç£ç›˜ä½¿ç”¨æƒ…å†µ
        echo "=== åˆå§‹ç£ç›˜ä½¿ç”¨æƒ…å†µ ==="
        df -h
        
        # æ›´å½»åº•çš„ç³»ç»Ÿæ¸…ç†
        echo "=== å¼€å§‹ç³»ç»Ÿæ¸…ç† ==="
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo rm -rf /usr/local/.ghcup /usr/local/lib/android /usr/local/share/boost /usr/local/go
        sudo rm -rf /opt/az /opt/microsoft /usr/share/swift /usr/local/share/chromium /usr/local/share/powershell
        
        # æ¸…ç† Docker å’Œå®¹å™¨ç›¸å…³
        sudo systemctl stop docker
        sudo docker system prune -a -f --volumes || true
        sudo rm -rf /var/lib/docker /var/lib/containerd
        
        # æ¸…ç†æ›´å¤šä¸éœ€è¦çš„è½¯ä»¶
        sudo rm -rf /usr/local/share/vcpkg /usr/local/share/cmake* /usr/local/graalvm /usr/local/sqlpackage
        sudo rm -rf /home/linuxbrew /usr/local/miniconda /usr/share/miniconda /usr/local/lib/heroku
        
        # æ¸…ç† APT ç¼“å­˜
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
        
        # æ¸…ç†æ—¥å¿—
        sudo journalctl --vacuum-time=1d
        sudo rm -rf /var/log/*.log /var/log/*/*.log
        
        echo "=== ç¬¬ä¸€è½®æ¸…ç†åç£ç›˜ä½¿ç”¨æƒ…å†µ ==="
        df -h
        
        # æ›´æ–°è½¯ä»¶æºå¹¶å®‰è£…ä¾èµ–
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3 python3-dev python3-distutils python3-setuptools \
          subversion swig time xsltproc zlib1g-dev rsync unzip
        
        # æ¸…ç†å®‰è£…ç¼“å­˜
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        
        # è®¾ç½®æ—¶åŒº
        sudo timedatectl set-timezone "$TZ"
        
        # è®¾ç½®ç¼–è¯‘ç¯å¢ƒå˜é‡
        echo "CCACHE_DIR=/tmp/ccache" >> $GITHUB_ENV
        echo "CCACHE_MAXSIZE=2G" >> $GITHUB_ENV
        
        echo "=== æœ€ç»ˆæ¸…ç†åç£ç›˜ä½¿ç”¨æƒ…å†µ ==="
        df -h
        echo "=== å¯ç”¨ç©ºé—´æ£€æŸ¥ ==="
        AVAIL_GB=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
        echo "å¯ç”¨ç©ºé—´: ${AVAIL_GB}GB"
        if [ $AVAIL_GB -lt 15 ]; then
          echo "âš ï¸  è­¦å‘Š: å¯ç”¨ç©ºé—´ä¸è¶³ 15GBï¼Œå¯èƒ½å½±å“ç¼–è¯‘"
        else
          echo "âœ… ç©ºé—´å……è¶³ï¼Œå¯ä»¥å¼€å§‹ç¼–è¯‘"
        fi

    - name: Clone Source Code
      run: |
        echo "=== å¼€å§‹å…‹éš†æºä»£ç  ==="
        # ä½¿ç”¨æµ…å…‹éš†èŠ‚çœç©ºé—´å’Œæ—¶é—´
        git clone $REPO_URL --depth 1 -b $REPO_BRANCH openwrt
        cd openwrt
        
        # åˆ‡æ¢åˆ°æŒ‡å®šç‰ˆæœ¬
        git fetch --depth 1 origin tag $REPO_VERSION
        git checkout $REPO_VERSION
        
        echo "=== æ›´æ–°å’Œå®‰è£…è½¯ä»¶æº ==="
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # æ¸…ç†ä¸éœ€è¦çš„è½¯ä»¶æºç¼“å­˜
        rm -rf feeds/*/tmp feeds/*/.git
        
        echo "=== æºç å‡†å¤‡å®Œæˆï¼Œå½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µ ==="
        df -h
        echo "=== OpenWrt æºç ç›®å½•å¤§å° ==="
        du -sh . 2>/dev/null || echo "æ— æ³•è®¡ç®—ç›®å½•å¤§å°"

    - name: Load Custom Configuration
      run: |
        cd openwrt
        # æ–¹å¼1: ä½¿ç”¨ä»“åº“ä¸­çš„é…ç½®æ–‡ä»¶
        if [ -f "../space-optimized.config" ]; then
          echo "=== ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ ==="
          cp ../space-optimized.config .config
        else
          echo "=== ä½¿ç”¨å†…ç½®é…ç½® ==="
          cat > .config <<EOF
          # ç›®æ ‡å¹³å°
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_DEVICE_generic=y
          
          # åˆ†åŒºå¤§å°ä¼˜åŒ–
          CONFIG_TARGET_KERNEL_PARTSIZE=32
          CONFIG_TARGET_ROOTFS_PARTSIZE=1024
          
          # åŸºç¡€ç³»ç»Ÿ
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-ssl=y
          
          # ä»£ç†å·¥å…·å¥—è£…
          CONFIG_PACKAGE_luci-app-openclash=y
          CONFIG_PACKAGE_luci-app-homeproxy=y
          CONFIG_PACKAGE_luci-app-passwall=y
          CONFIG_PACKAGE_luci-app-passwall2=y
          CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Xray=y
          CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Hysteria=y
          CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Rust_Client=y
          CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_Xray=y
          CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_Hysteria=y
          CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_Shadowsocks_Rust_Client=y
          
          # Docker æ”¯æŒ
          CONFIG_PACKAGE_luci-app-dockerman=y
          CONFIG_PACKAGE_luci-lib-docker=y
          CONFIG_PACKAGE_docker=y
          CONFIG_PACKAGE_dockerd=y
          CONFIG_DOCKER_CGROUP_OPTIONS=y
          CONFIG_DOCKER_NET_MACVLAN=y
          CONFIG_DOCKER_STO_EXT4=y
          CONFIG_KERNEL_CGROUP_DEVICE=y
          CONFIG_KERNEL_CGROUP_FREEZER=y
          CONFIG_KERNEL_NET_CLS_CGROUP=y
          CONFIG_KERNEL_EXT4_FS_POSIX_ACL=y
          CONFIG_KERNEL_FS_POSIX_ACL=y
          
          # ç½‘å¡é©±åŠ¨
          CONFIG_PACKAGE_kmod-igb=y
          CONFIG_PACKAGE_kmod-e1000e=y
          CONFIG_PACKAGE_kmod-r8169=y
          CONFIG_PACKAGE_kmod-r8125=y
          CONFIG_PACKAGE_kmod-igc=y
          
          # USB å’Œæ–‡ä»¶ç³»ç»Ÿ
          CONFIG_PACKAGE_kmod-usb-core=y
          CONFIG_PACKAGE_kmod-usb2=y
          CONFIG_PACKAGE_kmod-usb3=y
          CONFIG_PACKAGE_kmod-fs-ext4=y
          CONFIG_PACKAGE_kmod-fs-vfat=y
          
          # ä¸­æ–‡ç•Œé¢
          CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
          CONFIG_PACKAGE_luci-i18n-firewall-zh-cn=y
          CONFIG_PACKAGE_luci-i18n-dockerman-zh-cn=y
          CONFIG_PACKAGE_luci-i18n-passwall-zh-cn=y
          CONFIG_PACKAGE_luci-i18n-passwall2-zh-cn=y
          CONFIG_PACKAGE_luci-i18n-openclash-zh-cn=y
          CONFIG_PACKAGE_luci-i18n-homeproxy-zh-cn=y
          
          # ç¼–è¯‘å’Œå¼•å¯¼é…ç½®
          CONFIG_CCACHE=y
          CONFIG_BUILD_LOG=y
          CONFIG_GRUB_TIMEOUT="3"
          CONFIG_GRUB_TITLE="ImmortalWrt"
          CONFIG_GRUB_IMAGES=y
          CONFIG_TARGET_ROOTFS_EXT4FS=y
          CONFIG_TARGET_ROOTFS_SQUASHFS=y
          EOF
        fi
        
        # åº”ç”¨é…ç½®
        make defconfig
        
        # æ˜¾ç¤ºé…ç½®å·®å¼‚
        ./scripts/diffconfig.sh > diffconfig.txt
        echo "=== æœ€ç»ˆé…ç½®å·®å¼‚ ==="
        cat diffconfig.txt

    - name: Download Package
      run: |
        cd openwrt
        echo "=== å¼€å§‹ä¸‹è½½è½¯ä»¶åŒ… ==="
        make download -j8
        
        # æ¸…ç†ä¸‹è½½å¤±è´¥çš„æ–‡ä»¶
        find dl -size -1024c -exec ls -l {} \; || true
        find dl -size -1024c -exec rm -f {} \; || true
        
        echo "=== ä¸‹è½½å®Œæˆï¼Œç£ç›˜ä½¿ç”¨æƒ…å†µ ==="
        df -h

    - name: Compile Firmware
      id: compile
      run: |
        cd openwrt
        echo "=== ç¼–è¯‘å‰ç¯å¢ƒæ£€æŸ¥ ==="
        echo "å¯ç”¨CPUæ ¸å¿ƒ: $(nproc)"
        echo "å¯ç”¨å†…å­˜: $(free -h)"
        echo "ç£ç›˜ç©ºé—´: $(df -h /)"
        
        # æ£€æŸ¥å¯ç”¨ç©ºé—´
        AVAIL_GB=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
        echo "å‰©ä½™å¯ç”¨ç©ºé—´: ${AVAIL_GB}GB"
        
        if [ $AVAIL_GB -lt 10 ]; then
          echo "âŒ é”™è¯¯: å¯ç”¨ç©ºé—´ä¸è¶³ 10GBï¼Œæ— æ³•ç»§ç»­ç¼–è¯‘"
          exit 1
        fi
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export FORCE_UNSAFE_CONFIGURE=1
        export CCACHE_DIR=/tmp/ccache
        export CCACHE_MAXSIZE=2G
        
        # åˆ›å»ºç¼–è¯‘æ—¥å¿—ç›®å½•
        mkdir -p logs
        
        echo "=== å¼€å§‹ç¼–è¯‘å›ºä»¶ ==="
        echo "ç¼–è¯‘å¼€å§‹æ—¶é—´: $(date)"
        
        # å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨è¾ƒå°‘çš„å¹¶è¡Œåº¦ä»¥èŠ‚çœå†…å­˜
        JOBS=$(($(nproc) < 4 ? $(nproc) : 4))
        echo "ä½¿ç”¨ $JOBS ä¸ªå¹¶è¡Œä»»åŠ¡è¿›è¡Œç¼–è¯‘"
        
        make -j$JOBS V=s 2>&1 | tee logs/build.log || {
          echo "=== å¤šçº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘ ==="
          echo "å•çº¿ç¨‹ç¼–è¯‘å¼€å§‹æ—¶é—´: $(date)"
          
          # æ¸…ç†å¤±è´¥çš„ç¼–è¯‘æ–‡ä»¶ä»¥èŠ‚çœç©ºé—´
          make clean 2>/dev/null || true
          
          # å•çº¿ç¨‹ç¼–è¯‘
          make -j1 V=s 2>&1 | tee logs/build-single.log
        }
        
        echo "=== ç¼–è¯‘å®Œæˆ ==="
        echo "ç¼–è¯‘ç»“æŸæ—¶é—´: $(date)"
        echo "status=success" >> $GITHUB_OUTPUT
        
        echo "=== ç¼–è¯‘åç£ç›˜ä½¿ç”¨æƒ…å†µ ==="
        df -h
        
        # ç¼–è¯‘åæ¸…ç†ä»¥èŠ‚çœç©ºé—´
        echo "=== æ¸…ç†ç¼–è¯‘ç¼“å­˜ ==="
        make clean 2>/dev/null || true
        rm -rf build_dir/host build_dir/hostpkg tmp
        
        echo "=== æ¸…ç†åç£ç›˜ä½¿ç”¨æƒ…å†µ ==="
        df -h

    - name: Check Space Usage
      run: |
        echo "=== æœ€ç»ˆç©ºé—´ä½¿ç”¨æŠ¥å‘Š ==="
        df -h
        echo ""
        echo "=== ç¼–è¯‘ç›®å½•å¤§å° ==="
        du -sh openwrt/ 2>/dev/null || echo "æ— æ³•è®¡ç®—ç›®å½•å¤§å°"
        echo ""
        echo "=== å›ºä»¶æ–‡ä»¶ ==="
        find openwrt/bin/targets/ -name "*.img*" -o -name "*.bin" -o -name "*.gz" | head -10

    - name: Organize Files
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload Firmware Directory
      uses: actions/upload-artifact@v4
      if: steps.compile.outputs.status == 'success' && !cancelled()
      with:
        name: immortalwrt-24.10.2-x86_64
        path: ${{ env.FIRMWARE }}
        retention-days: 7

    - name: Generate Release Tag
      id: tag
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        echo "release_tag=24.10.2-$(date +"%Y%m%d%H%M")" >> $GITHUB_OUTPUT
        echo "release_date=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT

    - name: Upload Firmware To Release
      uses: softprops/action-gh-release@master
      if: steps.compile.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        name: ImmortalWrt_24.10.2_${{ steps.tag.outputs.release_date }}
        body: |
          ## ğŸš€ ImmortalWrt 24.10.2 ç©ºé—´ä¼˜åŒ–ç‰ˆ
          
          **æ„å»ºæ—¶é—´**: ${{ steps.tag.outputs.release_date }}  
          **ç›®æ ‡å¹³å°**: x86_64  
          **ç‰ˆæœ¬**: 24.10.2 æœ€æ–°ç¨³å®šç‰ˆ
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - âœ… **OpenClash** - Clash ä»£ç†å·¥å…·
          - âœ… **HomeProxy** - é€æ˜ä»£ç†
          - âœ… **PassWall** - ç§‘å­¦ä¸Šç½‘å·¥å…·
          - âœ… **PassWall2** - æ–°ä¸€ä»£ç§‘å­¦ä¸Šç½‘å·¥å…· ğŸ†•
          - âœ… **Docker + DockerMan** - å®¹å™¨ç®¡ç†
          - âœ… **å®Œæ•´ç½‘å¡é©±åŠ¨** (åŒ…å«2.5Gç½‘å¡æ”¯æŒ)
          - âœ… **ä¸­æ–‡ç•Œé¢** - å®Œæ•´æœ¬åœ°åŒ–
          
          ### ğŸ”§ ç³»ç»Ÿé…ç½®
          - å†…æ ¸åˆ†åŒº: 32MB
          - æ ¹åˆ†åŒº: 1024MB (ä¼˜åŒ–ç‰ˆ)
          - å¼•å¯¼æ–¹å¼: GRUB (æ”¯æŒUEFI)
          
          ### ğŸ“¥ ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½å¯¹åº”å›ºä»¶æ–‡ä»¶
          2. ä½¿ç”¨ Rufus/Etcher å†™å…¥Uç›˜æˆ–ç¡¬ç›˜
          3. é»˜è®¤IP: `192.168.1.1`
          4. ç”¨æˆ·å: `root`ï¼Œå¯†ç : ç©º
          
          ### âš¡ æ€§èƒ½ä¼˜åŒ–
          - å¯ç”¨ç¼–è¯‘ç¼“å­˜åŠ é€Ÿ
          - ä¼˜åŒ–ç£ç›˜å ç”¨
          - ç²¾ç®€ä¸å¿…è¦ç»„ä»¶
          
          > æ­¤ç‰ˆæœ¬ä¸“é—¨é’ˆå¯¹ GitHub Actions å…è´¹ç©ºé—´é™åˆ¶ä¼˜åŒ–ï¼Œç¡®ä¿ç¼–è¯‘æˆåŠŸç‡ã€‚
        files: ${{ env.FIRMWARE }}/*
        draft: false
        prerelease: false

    - name: Delete Workflow Runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ github.token }}
        repository: ${{ github.repository }}
        retain_days: 3
        keep_minimum_runs: 2

    - name: Remove Old Releases
      uses: dev-drprasad/delete-older-releases@v0.3.4
      if: steps.compile.outputs.status == 'success' && !cancelled()
      with:
        keep_latest: 5
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
