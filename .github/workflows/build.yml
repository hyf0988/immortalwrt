name: Build ImmortalWrt23.05 Stable with Image Builder

on:
  workflow_dispatch:
    inputs:
      rootfs_size:
        description: '请输入固件根分区的最终大小 (MB)'
        required: true
        default: '2048'
      router_ip:
        description: '请设置路由器的默认管理IP地址'
        required: true
        default: '192.168.100.1'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Build Environment
        id: prepare
        run: |
          mkdir -p files/etc/config bin
          echo "LAN_IP=${{ github.event.inputs.router_ip }}" > files/etc/config/custom_lan_ip
          
          # Define package list
          PACKAGES=" \
            luci \
            luci-ssl-openssl \
            libustream-openssl \
            -luci-ssl \
            -libustream-wolfssl \
            -libustream-mbedtls \
            ppp \
            luci-proto-ppp \
            ca-bundle \
            libopenssl \
            luci-app-openclash \
            luci-app-homeproxy \
            luci-app-passwall \
            luci-app-dockerman \
            luci-lib-docker \
            docker \
            dockerd \
            kmod-igb \
            kmod-e1000e \
            kmod-r8169 \
            kmod-r8125 \
            kmod-igc \
            kmod-usb-core \
            kmod-usb2 \
            kmod-usb3 \
            kmod-fs-ext4 \
            kmod-fs-vfat \
            luci-i18n-base-zh-cn \
            luci-i18n-firewall-zh-cn \
            luci-i18n-dockerman-zh-cn \
            luci-i18n-passwall-zh-cn \
            luci-i18n-openclash-zh-cn \
            luci-i18n-homeproxy-zh-cn \
          "
          echo "packages=$(echo $PACKAGES | tr -s ' ')" >> $GITHUB_OUTPUT
          echo "rootfs_size=${{ github.event.inputs.rootfs_size }}" >> $GITHUB_OUTPUT

      - name: Build Firmware with Image Builder
        run: |
          # ✅ FIX: Use the stable 23.05.3 Image Builder
          docker run --rm -i \
            --user root \
            -v ./bin:/home/build/immortalwrt/bin \
            -v ./files:/home/build/immortalwrt/files \
            immortalwrt/imagebuilder:x86-64-openwrt-23.05.3 \
            /bin/bash -c '
              echo "185.199.108.133 raw.githubusercontent.com" >> /etc/hosts
              
              # Use the stable 23.05 package feed
              echo "src/gz sbwml_packages https://raw.githubusercontent.com/sbwml/openwrt_pkgs/23.05/packages/x86_64" >> repositories.conf
              
              # Update package lists
              make info
              
              # Build image
              make image V=s PROFILE="generic" PACKAGES="${{ steps.prepare.outputs.packages }}" FILES="files" ROOTFS_SIZE="${{ steps.prepare.outputs.rootfs_size }}"
            '

      - name: Organize Files and Create Info
        id: organize
        run: |
          FIRMWARE_PATH=$(find ./bin/targets/x86/64 -type f -name "*squashfs-combined-efi.img.gz" | head -n 1)
          if [[ -z "$FIRMWARE_PATH" ]]; then
            echo "::error::Firmware file not found, build failed!"
            exit 1
          fi
          
          echo "FIRMWARE_PATH=$FIRMWARE_PATH" >> $GITHUB_ENV
          
          cat > ./router-info.md <<EOF
          ## 🚀 ImmortalWrt 23.05.3 Stable (Image Builder)

          - 🏠 **后台地址**: ${{ github.event.inputs.router_ip }}
          - 👤 **用户名**: root
          - 🔑 **密码**: 无
          - 💾 **固件大小**: ${{ github.event.inputs.rootfs_size }} MB
          EOF

      - name: Upload Firmware to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ImmortalWrt-23.05.3-Stable-$(date +%Y-%m-%d)
          body_path: ./router-info.md
          files: |
            ${{ env.FIRMWARE_PATH }}
          token: ${{ secrets.GITHUB_TOKEN }}
          replace_latest: true
